name: Pull Request CI

on:
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

env:
  CI: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

  unit-tests:
    name: Unit Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Upload unit coverage
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: unit-coverage
          path: coverage/

  e2e-tests:
    name: E2E Tests
    needs: lint
    runs-on: ubuntu-latest
    environment: integration
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      E2E_AUTH_MOCK: ${{ secrets.E2E_AUTH_MOCK || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests with coverage
        env:
          NODE_V8_COVERAGE: ./coverage-e2e
        run: npx playwright test --config=playwright.config.e2e.ts

      - name: Upload E2E coverage
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-coverage
          path: coverage-e2e/

  security-scan:
    name: Security Scan
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (high+)
        run: npm audit --audit-level=high

  coverage-report:
    name: Coverage Report
    needs:
      - unit-tests
      - e2e-tests
    runs-on: ubuntu-latest
    outputs:
      coverage_table: ${{ steps.coverage-summary.outputs.coverage_table }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download unit coverage
        uses: actions/download-artifact@v5
        with:
          name: unit-coverage
          path: coverage/unit

      - name: Download e2e coverage
        uses: actions/download-artifact@v5
        with:
          name: e2e-coverage
          path: coverage/e2e

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Install dependencies (coverage tooling)
        run: npm ci --omit=optional

      - name: Build E2E coverage summary
        run: |
          npx c8 report \
            --reporter=json-summary \
            --reports-dir=coverage/e2e/coverage \
            --temp-directory=coverage/e2e

      - name: Generate coverage summary
        id: coverage-summary
        run: |
          node <<'NODE'
          import fs from 'node:fs';
          import path from 'node:path';

          const candidates = [
            { label: 'Unit', path: path.join('coverage', 'unit', 'coverage-summary.json') },
            { label: 'Unit', path: path.join('coverage', 'unit', 'coverage', 'coverage-summary.json') },
            { label: 'E2E', path: path.join('coverage', 'e2e', 'coverage-summary.json') },
            { label: 'E2E', path: path.join('coverage', 'e2e', 'coverage', 'coverage-summary.json') },
          ];

          const rows = [];
          const formatPct = (value) => (typeof value === 'number' ? value.toFixed(1) : 'n/a');
          const statusIcon = (pct) => {
            if (typeof pct !== 'number') return '‚ö™Ô∏è';
            if (pct >= 90) return 'üü¢';
            if (pct >= 75) return 'üü°';
            return 'üî¥';
          };

          for (const candidate of candidates) {
            if (!fs.existsSync(candidate.path)) continue;

            const summary = JSON.parse(fs.readFileSync(candidate.path, 'utf8'));
            const totals = summary.total;
            const suite = {
              label: candidate.label,
              icon: statusIcon(totals?.lines?.pct),
              lines: formatPct(totals?.lines?.pct),
              branches: formatPct(totals?.branches?.pct),
              functions: formatPct(totals?.functions?.pct),
              statements: formatPct(totals?.statements?.pct),
            };

            if (rows.some((row) => row.label === suite.label)) continue;
            rows.push(suite);
          }

          const table = rows.length
            ? [
                '| Suite | Lines | Branches | Functions | Statements |',
                '| --- | --- | --- | --- | --- |',
                ...rows.map(
                  (row) =>
                    `| ${row.icon} ${row.label} | ${row.lines}% | ${row.branches}% | ${row.functions}% | ${row.statements}% |`,
                ),
              ].join('\n')
            : '_No coverage summary files found._';

          const summaryPath = path.join('coverage', 'coverage-summary.md');
          fs.mkdirSync(path.dirname(summaryPath), { recursive: true });
          fs.writeFileSync(summaryPath, table);

          const output = ['coverage_table<<EOF', table, 'EOF'].join('\n');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `${output}\n`);
          NODE

      - name: Bundle coverage
        run: tar -czf coverage-bundle.tar.gz coverage

      - name: Upload bundled coverage
        uses: actions/upload-artifact@v5
        with:
          name: coverage-bundle
          path: coverage-bundle.tar.gz

  status-comment:
    name: Status Comment
    needs:
      - lint
      - unit-tests
      - e2e-tests
      - security-scan
      - coverage-report
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Add PR status comment
        uses: actions/github-script@v8
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          E2E_RESULT: ${{ needs.e2e-tests.result }}
          SECURITY_RESULT: ${{ needs.security-scan.result }}
          COVERAGE_RESULT: ${{ needs.coverage-report.result }}
          COVERAGE_TABLE: ${{ needs.coverage-report.outputs.coverage_table }}
        with:
          script: |
            const results = {
              lint: process.env.LINT_RESULT,
              unit: process.env.UNIT_RESULT,
              e2e: process.env.E2E_RESULT,
              security: process.env.SECURITY_RESULT,
              coverage: process.env.COVERAGE_RESULT,
            };

            const icon = (status) => {
              if (status === 'success') return '‚úÖ';
              if (status === 'skipped') return '‚ö†Ô∏è';
              return '‚ùå';
            };

            const body = [
              '## Pull Request CI Status',
              '',
              `- Lint: ${icon(results.lint)} \`${results.lint}\``,
              `- Unit Tests: ${icon(results.unit)} \`${results.unit}\``,
              `- E2E Tests: ${icon(results.e2e)} \`${results.e2e}\``,
              `- Security Scan: ${icon(results.security)} \`${results.security}\``,
              `- Coverage Report: ${icon(results.coverage)} \`${results.coverage}\``,
            ];

            if (process.env.COVERAGE_TABLE) {
              body.push('', '### Coverage Summary', process.env.COVERAGE_TABLE);
            }

            const bodyText = body.join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: bodyText,
            });