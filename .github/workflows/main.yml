name: Main Branch CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  CI: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

  unit-tests:
    name: Unit Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Upload unit coverage
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: unit-coverage
          path: coverage/

  e2e-tests:
    name: E2E Tests
    needs: lint
    runs-on: ubuntu-latest
    environment: integration
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      E2E_AUTH_MOCK: ${{ secrets.E2E_AUTH_MOCK || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests with coverage
        env:
          NODE_V8_COVERAGE: ./coverage-e2e
        run: npx playwright test --config=playwright.config.e2e.ts

      - name: Upload E2E coverage
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-coverage
          path: coverage-e2e/

  security-scan:
    name: Security Scan
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (high+)
        run: npm audit --audit-level=high

  coverage-report:
    name: Coverage Report
    needs:
      - unit-tests
      - e2e-tests
    runs-on: ubuntu-latest
    outputs:
      coverage_table: ${{ steps.coverage-summary.outputs.coverage_table }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download unit coverage
        uses: actions/download-artifact@v5
        with:
          name: unit-coverage
          path: coverage/unit

      - name: Download e2e coverage
        uses: actions/download-artifact@v5
        with:
          name: e2e-coverage
          path: coverage/e2e

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Generate coverage summary
        id: coverage-summary
        run: |
          node <<'NODE'
          import fs from 'node:fs';
          import path from 'node:path';

          const candidates = [
            { label: 'Unit', path: path.join('coverage', 'unit', 'coverage-summary.json') },
            { label: 'Unit', path: path.join('coverage', 'unit', 'coverage', 'coverage-summary.json') },
            { label: 'E2E', path: path.join('coverage', 'e2e', 'coverage-summary.json') },
            { label: 'E2E', path: path.join('coverage', 'e2e', 'coverage', 'coverage-summary.json') },
          ];

          const rows = [];
          const formatPct = (value) => (typeof value === 'number' ? value.toFixed(1) : 'n/a');
          const statusIcon = (pct) => {
            if (typeof pct !== 'number') return 'âšªï¸';
            if (pct >= 90) return 'ðŸŸ¢';
            if (pct >= 75) return 'ðŸŸ¡';
            return 'ðŸ”´';
          };

          for (const candidate of candidates) {
            if (!fs.existsSync(candidate.path)) continue;

            const summary = JSON.parse(fs.readFileSync(candidate.path, 'utf8'));
            const totals = summary.total;
            const suite = {
              label: candidate.label,
              icon: statusIcon(totals?.lines?.pct),
              lines: formatPct(totals?.lines?.pct),
              branches: formatPct(totals?.branches?.pct),
              functions: formatPct(totals?.functions?.pct),
              statements: formatPct(totals?.statements?.pct),
            };

            if (rows.some((row) => row.label === suite.label)) continue;
            rows.push(suite);
          }

          const table = rows.length
            ? [
                '| Suite | Lines | Branches | Functions | Statements |',
                '| --- | --- | --- | --- | --- |',
                ...rows.map(
                  (row) =>
                    `| ${row.icon} ${row.label} | ${row.lines}% | ${row.branches}% | ${row.functions}% | ${row.statements}% |`,
                ),
              ].join('\n')
            : '_No coverage summary files found._';

          const summaryPath = path.join('coverage', 'coverage-summary.md');
          fs.mkdirSync(path.dirname(summaryPath), { recursive: true });
          fs.writeFileSync(summaryPath, table);

          const output = ['coverage_table<<EOF', table, 'EOF'].join('\n');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `${output}\n`);
          NODE

      - name: Bundle coverage
        run: tar -czf coverage-bundle.tar.gz coverage

      - name: Upload bundled coverage
        uses: actions/upload-artifact@v5
        with:
          name: coverage-bundle
          path: coverage-bundle.tar.gz

